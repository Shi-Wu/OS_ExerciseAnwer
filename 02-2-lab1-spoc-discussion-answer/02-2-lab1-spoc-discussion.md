##lec4课堂SPOC练习

#### 1. 描述符特权级DPL、当前特权级CPL和请求特权级RPL的含义是什么？在哪些寄存器中这些字段？对应的访问条件是什么？ (challenge)写出一些简单的小程序（c or asm）来体现这些特权级的区别和联系。

 - DPL存储在段描述符中，规定访问该段的权限级别(Descriptor Privilege Level)，每个段的DPL固定。
 - CPL是当前进程的权限级别(Current Privilege Level)，是当前正在执行的代码所在的段的特权级，存在于cs寄存器的低两位。
 - RPL说明的是进程对段访问的请求权限(Request Privilege Level)，是对于段选择子而言的，每个段选择子有自己的RPL，它说明的是进程对段访问的请求权限，有点像函数参数。而且RPL对每个段来说不是固定的，两次访问同一段时的RPL可以不同。RPL可能会削弱CPL的作用，例如当前CPL=0的进程要访问一个数据段，它把段选择符中的RPL设为3，这样虽然它对该段仍然只有特权为3的访问权限。

 当进程访问一个段时，需要进程特权级检查，一般要求DPL >= max {CPL, RPL}


2.比较不同特权级的中断切换时的堆栈变化差别；(challenge)写出一些简单的小程序（c or asm）来显示出不同特权级的的中断切换的堆栈变化情况。

当没有特权级转换的时候：

      D  O      31          0                     31          0
      I  F    |-------+-------|                 |-------+-------|
      R       |#######|#######|    OLD          |#######|#######|    OLD
      E  E    |-------+-------|   SS:ESP        |-------+-------|   SS:ESP
      C  X    |#######|#######|     |           |#######|#######|     |
      T  P    |-------+-------|<----+           |-------+-------|<----+
      I  A    |  OLD EFLAGS   |                 |  OLD EFLAGS   |
      O  N    |-------+-------|                 |-------+-------|
      N  S    |#######|OLD CS |    NEW          |#######|OLD CS |
         I    |-------+-------|   SS:ESP        |-------+-------|
       | O    |    OLD EIP    |     |           |    OLD EIP    |    NEW
       | N    |---------------|<----+           |---------------|   SS:ESP
       |      |               |                 |  ERROR CODE   |     |
       !      *               *                 |---------------|<----+
              *               *                 |               |
              *               *
              WITHOUT ERROR CODE                 WITH ERROR CODE


当有特权级转换的时候：

      D  O     31            0                     31          0
      I  F    +-------+-------+<----+           +-------+-------+<----+
      R       |#######|OLD SS |     |           |#######|OLD SS |     |
      E  E    |-------+-------|   SS:ESP        |-------+-------|   SS:ESP
      C  X    |    OLD ESP    |  FROM TSS       |    OLD ESP    |  FROM TSS
      T  P    |---------------|                 |---------------|
      I  A    |  OLD EFLAGS   |                 |  OLD EFLAGS   |
      O  N    |-------+-------|                 |-------+-------|
      N  S    |#######|OLD CS |    NEW          |#######|OLD CS |
         I    |-------+-------|   SS:EIP        |-------+-------|
       | O    |    OLD EIP    |     |           |    OLD EIP    |    NEW
       | N    |---------------|<----+           |---------------|   SS:ESP
       |      |               |                 |  ERROR CODE   |     |
       !      *               *                 |---------------|<----+
              *               *                 |               |
              *               *
              WITHOUT ERROR CODE                 WITH ERROR CODE

可以看出，当有特权级转换时，堆栈中会多保存 old ss 和 old esp。